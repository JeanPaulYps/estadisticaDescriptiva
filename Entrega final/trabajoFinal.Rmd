---
title: "Trabajo Final"
author: "Jean Paul Yepes"
output: html_document
    
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r}
library(tidyverse)
```


```{r}
resultadosEncuesta <- read.csv("ResultadosEncuesta.csv",
                    encoding = "UTF-8",
                    stringsAsFactors = FALSE)
```

```{r}
createDirectory <- function ()
{
  if (dir.exists("img"))
  {
    unlink("img", recursive = TRUE)
  }
  dir.create("img")
}
createDirectory()
```



```{r, include=FALSE}
downloadImages <- function(resultadosEncuesta)
{
  numberOfImage = 1;
  for (imageURL in resultadosEncuesta$En.el.rectángulo.blanco.a.continuación..ponga.50.puntos.de.manera.aleatoria)
  {
    
    download.file(imageURL, destfile = sprintf("img/%03d.png", numberOfImage), method = "wget")
    numberOfImage = numberOfImage + 1;
  }
}

downloadImages(resultadosEncuesta)
```

```{r}
library("Rvision")
image = image(filename = "img/062.png")
dots = simpleBlobDetector(
  image,
  min_threshold = 1,
  max_threshold = 255,
  threshold_step = 10,
  min_repeatability = 2,
  min_dist_between_blobs = 10,
  filter_by_area = TRUE,
  min_area = 10,
  max_area = 5000,
  filter_by_color = TRUE,
  blob_color = 0,
  filter_by_circularity = FALSE,
  min_circularity = 0.8,
  max_circularity = Inf,
  filter_by_convexity = TRUE,
  min_convexity = 0.85,
  max_convexity = Inf,
  filter_by_inertia = TRUE,
  min_inertia_ratio = 0.1,
  max_inertia_ratio = Inf
)
plot(image, main = "x")
plot(dots, pch = 1)
#points(dots$x, dots$y)
```
```{r}


```




```{r}
library(tidyverse)
print(dots %>% select(x,y))
#heatmap(as.matrix(dots %>% select(x,y) ), scale= "row" )
test <- expand.grid()
ggplot(dots, aes(x, y, fill= size)) + 
  geom_tile()
```


```{r}
x <- as.character(seq(50,600,50))
y <- as.character(seq(50,600,50))
df <- expand.grid(x,y)
df$rand =sample(100, size = nrow(df), replace = TRUE)
df
```




```{r}
getCoordsInImage <- function(imageFileToDetect)
{
  dots = simpleBlobDetector(
      imageFileToDetect,
      min_threshold = 1,
      max_threshold = 255,
      threshold_step = 10,
      min_repeatability = 2,
      min_dist_between_blobs = 10,
      filter_by_area = TRUE,
      min_area = 10,
      max_area = 5000,
      filter_by_color = TRUE,
      blob_color = 0,
      filter_by_circularity = FALSE,
      min_circularity = 0.8,
      max_circularity = Inf,
      filter_by_convexity = TRUE,
      min_convexity = 0.85,
      max_convexity = Inf,
      filter_by_inertia = TRUE,
      min_inertia_ratio = 0.1,
      max_inertia_ratio = Inf
  )
  return(dots);
}
```



```{r}
obtainPointsLocation <- function()
{
  pointsLocation = NULL;
  for (imageFileName in dir("img/"))
  {
    rowNumber = as.integer(str_remove(imageFileName, ".png"));
    imageFile = image(filename = paste("img/", imageFileName, sep ="") );
    pointsLocationOfImage = getCoordsInImage(imageFile);
    if (nrow(pointsLocationOfImage) <= 40 || nrow(pointsLocationOfImage) >= 60)
    {
      next;
    }
    pointsLocationOfImage$ImageRow = rowNumber;
    pointsLocation <- rbind(pointsLocation, pointsLocationOfImage);
  }
  pointsLocation$y = 600 - pointsLocation$y;
  return (pointsLocation);
}
res = obtainPointsLocation()
```


```{r}

 xy <- matrix(runif(40), ncol=2)
print(xy)


```

```{r}
library(spatstat)
pointsToRipley <- ppp(res$x, res$y, c(1, 600), c(1,600))
kDeRipley <- Kest(pointsToRipley)
plot(kDeRipley)

```

```{r}
intervalo_conf <- envelope(pointsToRipley, nsim=100)
```

```{r}
plot(intervalo_conf)
```



```{r}
xy <- res %>% select(x,y)
xy$x = as.integer(xy$x)
xy$y =as.integer(xy$y)
persp(density(pointsToRipley), theta=30, phi=30)
```

```{r}
plot(density(pointsToRipley))
points(xy)
```
  
```{r}
summary(pointsToRipley)
```
```{r}
print(head(pointsToRipley$y, n=200))
```
  
```{r}
xy$y = 600 + xy$y
plot(xy)
```
  
  
```{r}
imagen1 <- res %>% filter(ImageRow == 1)
```

```{r}
plot(imagen1)
```
```{r}
plot(density( ppp(imagen1$x, imagen1$y, c(1, 600), c(1, 600))))
```
```{r}
imagen1Arreglada = imagen1 %>% mutate(y = 600 - y)
```


```{r}
xmin = 0;
xmax = 600;
ymin = 0;
ymax = 600;
PruebaPuntos = ppp(imagen1Arreglada$x, imagen1Arreglada$y, c(1, 600), c(1, 600))

plot(density(PruebaPuntos),  xlim=c(xmin, xmax), ylim=c(ymin, ymax) )
axis(2, at=seq(0,600,100),labels=seq(0,600,100), col.axis="black", las=2)
axis(1, at=seq(0,600,100),labels=seq(0,600,100), col.axis="black", las=2)
points(PruebaPuntos)

``` 

```{r}
coordenadasPuntos = res
```

```{r}
saveRDS(coordenadasPuntos, file = "coordenadasPuntos.Rdata")
```

  
