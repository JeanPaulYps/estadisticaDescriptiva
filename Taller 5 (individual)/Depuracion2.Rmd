---
title: "Depuración de la base de datos"
author: "Jean Paul Yepes"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r}
library(tidyverse)
library(knitr)
```

```{r}
datosAccidentes <- read.csv("Accidentalidad_con_motos_municipio_de_Medell_n_actualizado_a_julio_2020.csv",
                    encoding = "UTF-8",
                    stringsAsFactors = FALSE)
```

# Problemas con las fechas 

Al revisar los datos, se evidencia que hay una inconsistencia en los datos, debido a que hay una columna para 
las fechas y otra columna para las horas, aunque la columna fechas contiene tambien una hora, esta hora no es
correcta y se podría corregir esta columna solo dejando la fecha del accidente y la hora aparte.

```{r}
muestraFechaHoraIncorrecta = datosAccidentes %>% select("FECHA_ACCIDENTE")
knitr::kable(head(muestraFechaHoraIncorrecta) , col.names = c("FECHA_ACCIDENTE"), caption = "Table 1: columna fecha del accidente")
```

```{r}
fixHours <- function(dateBroken) {
    dateFixed = as.Date(dateBroken, "%d/%m/%Y %I:%M:%S %p")
    if(is.na(dateFixed))
    {
      dateFixed = as.Date(dateBroken, "%m/%d/%Y %I:%M:%S %p")
    }
    return (as.character(dateFixed))
      
}
```



```{r}
fechaDelAccidenteEnArchivo = datosAccidentes$FECHA_ACCIDENTE
fechaDelAccidenteEnArchivoCorregida = as.Date(fechaDelAccidenteEnArchivo, "%m/%d/%Y %I:%M:%S %p") 
datosAccidentes$FECHA_ACCIDENTE = as.Date(fechaDelAccidenteEnArchivoCorregida)
```

```{r}
knitr::kable(head( datosAccidentes %>% select("FECHA_ACCIDENTE")) , col.names = c("FECHA_ACCIDENTE"), caption = "Table 2: columnas fecha arreglada")
```


```{r}
IsDate = function(mydate, date.format = "%H:%M:%S") {
  tryCatch(!is.na(as.Date(mydate, date.format)),  
           error = function(err) {FALSE})  
}

```



```{r}
horas = datosAccidentes$HORA_ACCIDENTE
horasConFormatoIncorrecto = head(datosAccidentes$HORA_ACCIDENTE[!IsDate(horas)])
knitr::kable(horasConFormatoIncorrecto , col.names = c("HORA_ACCIDENTE"), caption = "Table 3: columna horas con formato incorrecto")
```


```{r}

fixHours = function(hour)
{
  if(IsDate(hour))
  {
      return (hour)
  }
  else
  {
    regex = "(?<=[a-zA-Z])[0-9]{2}:[0-9]{2}:[0-9]{2}"
    return(str_extract(hour, regex))
  }
}

datosAccidentes$HORA_ACCIDENTE = sapply(horas, fixHours)
```




```{r}
knitr::kable(head(datosAccidentes$HORA_ACCIDENTE[!IsDate(horas)]) , col.names = c("HORA_ACCIDENTE"), caption = "Table 4: columna horas con formato arreglado")
```

# Agregar coordenadas a los accidentes

```{r}
datosConCoordenadas <- read.csv("Datos_con_coordenadas.csv",
                    encoding = "UTF-8",
                    stringsAsFactors = FALSE, sep = ";")

```

```{r}
datosAccidentes$longitud = datosConCoordenadas$longitud
datosAccidentes$latitud = datosConCoordenadas$latitud
```

```{r}
knitr::kable(head(datosAccidentes[, c(1,10,11) ], 10), caption = "Tabla 5: Tabla con longitudes")
```




# Eliminar filas sin direcciones

```{r}
knitr::kable(datosAccidentes[datosAccidentes$DIRECCION == "", c(1,7) ], caption = "Tabla 5: filas que no tienen direcciones")
```


```{r}
datosAccidentes = datosAccidentes[!datosAccidentes$DIRECCION == "", ]
```



# Eliminar radicados duplicados

```{r}
test = datosAccidentes
knitr::kable(datosAccidentes[duplicated(datosAccidentes$NRO_RADICADO), c(1,7)], caption="Tabla xx: radicados duplicados")
```

```{r}
datosAccidentes = datosAccidentes[!duplicated(datosAccidentes$NRO_RADICADO),]
```



# Eliminar direcciones vacías o extrañas

```{r}
knitr::kable(head(datosAccidentes[datosAccidentes$DIRECCION == "Calle 1 Con Carrera 1" | grepl(".*999.*", datosAccidentes$DIRECCION), c(1,7) ], 10), 
             caption = "Tabla xx: direcciones sin sentido")
```

```{r}
knitr::kable(count( datosAccidentes[datosAccidentes$DIRECCION == "Calle 1 Con Carrera 1" | grepl(".*999.*", datosAccidentes$DIRECCION), ]),
             caption = "Tabla xx: Numero de accidentes con direcciones raras")
```

```{r}
datosAccidentes = datosAccidentes[!datosAccidentes$DIRECCION == "Calle 1 Con Carrera 1" & !grepl(".*999.*", datosAccidentes$DIRECCION), ]
```




# Eliminar zonas exptrañas 

```{r}
#unique(datosAccidentes[!grepl(".*COMUNA.*", datosAccidentes$ZONA) &  !grepl(".*CORREGIMIENTO.*" , datosAccidentes$ZONA), 8])
#length(datosAccidentes[!grepl(".*COMUNA.*", datosAccidentes$ZONA) &  !grepl(".*CORREGIMIENTO.*" , datosAccidentes$ZONA), 8])
knitr::kable(unique(datosAccidentes[!grepl(".*COMUNA.*", datosAccidentes$ZONA) &  !grepl(".*CORREGIMIENTO.*" , datosAccidentes$ZONA), 8])
             , caption = "Tabla 5: Zonas extrañas")
```



```{r}
knitr::kable(length(datosAccidentes[!grepl(".*COMUNA.*", datosAccidentes$ZONA) &  !grepl(".*CORREGIMIENTO.*" , datosAccidentes$ZONA), 8])
             ,col.names=c("Numero de filas cambiadas"),  caption = "Tabla 6: Numero de Zonas extrañas")
```


```{r}
datosAccidentes =  datosAccidentes[grepl(".*COMUNA.*", datosAccidentes$ZONA) | grepl(".*CORREGIMIENTO.*" , datosAccidentes$ZONA),  ]
```
# Cambiar nombre a las zonas

```{r}
knitr::kable(unique(datosAccidentes$ZONA), col.names = c("ZONA"), caption="Nombres de barrios en la base de datos")
```


```{r}
datosAccidentes[datosAccidentes$ZONA == "COMUNA 1", 8 ] <- "Popular"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 2", 8 ] <- "Santa Cruz"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 3", 8 ] <- "Manrique"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 4", 8 ] <- "Aranjuez"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 5", 8 ] <- "Castilla"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 6", 8 ] <- "Doce de octubre"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 7", 8 ] <- "Robledo"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 8", 8 ] <- "Villa Hermosa"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 9", 8 ] <- "Buenos Aires"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 10", 8 ] <- "La Candelaria"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 11", 8 ] <- "Laureles Estadio"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 12", 8 ] <- "La América"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 13", 8 ] <- "San Javier"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 14", 8 ] <- "Poblado"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 15", 8 ] <- "Guayabal"
datosAccidentes[datosAccidentes$ZONA == "COMUNA 16", 8 ] <- "Belén"
datosAccidentes[datosAccidentes$ZONA == "CORREGIMIENTO SAN CRISTOBAL Jurisdicción", 8 ] <- "Corregimiento de San Cristóbal"
datosAccidentes[datosAccidentes$ZONA == "CORREGIMIENTO PALMITAS Jurisdicción", 8 ] <- "Corregimiento de San Sebastián de Palmitas"
datosAccidentes[datosAccidentes$ZONA == "CORREGIMIENTO SANTA ELENA Jurisdicción", 8 ] <- "Corregimiento de Santa Elena"

```

```{r}
knitr::kable(unique(datosAccidentes$ZONA), col.names = c("ZONA"), caption = "Nuevos nombres de los barrios")
```



```{r}
#save(datosAccidentes, file = "datosAccidentes.RData")
```

```{r}
#rm(list = ls())
```





